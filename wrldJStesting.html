<head>


<script src="https://cdn-webgl.wrld3d.com/wrldjs/dist/latest/wrld.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" rel="stylesheet" />

<style>
      #floorButtons {
        position: absolute;
        z-index: 20;
      }

      #floorButtons button {
        display: block;
        width: 100%;
      }
	  
	  

	  
	  
	  
    </style>

<head/>

<body>

  <div style="position: relative">
  
  <div id="floorButtons">
	<button type="button" onclick="topFloor()">Top Floor</button>
      <button type="button" onclick="moveUp()">Move Up</button>
      <button type="button" onclick="moveDown()">Move Down</button>
      <button type="button" onclick="bottomFloor()">Bottom Floor</button>
      <button type="button" onclick="exitIndoors()">Exit</button>

    </div>
	

  
    <div id="map" style="height: 700px"></div>

<script src="https://cdn-webgl.wrld3d.com/wrldjs/dist/latest/wrld.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" rel="stylesheet" />
<div id="map" style="height: 250px"></div>
<script>
	
	
	var map = L.Wrld.map("map", "53f4c834b8971f09274f49d43fa3f85c", {center: [56.4599, -2.97],zoom: 16, indoorsEnabled: true} );
	var mousePoint = null;
	var popup = null;

	var updateCnt = 29;
	var popUpTime = new Date();
	var currentContent;
	var selctedDeskInUse = false;
	
	

	
	
	//This code makes a map appear
	var marker = L.marker([56.459997, -2.978281], {title: "TEST MARKER!", indoorMapId: "westport_house", indoorMapFloorId: 2}).addTo(map);
	
	//This code is from the example, used to control floor buttons https://www.wrld3d.com/wrld.js/latest/docs/examples/move-between-indoor-map-floors/
	
	marker.bindPopup('<p style="color:red;">This is a paragraph.</p>').openPopup();
	
	map.on("initialstreamingcomplete", function(e) {
    
		map.indoors.enter("westport_house");
		map.indoors.setFloor(2);
	});
	
	
	//Called when an entity is clicked
	function onIndoorEntityClicked(event) 
	{
		highlightDesks();
        var state = 0;
		
		if ((event.ids[1] != null) && (event.ids[1] < 41))//Because of the order of how things are projected a desk ID will always be second as room is always first. Therefore if there is no second value no desk has been clicked on
		{
			//Step send the desk to the PHP file for handling stuff using chinese resturant part 5
			
			xmlhttp = new XMLHttpRequest(); //This creates a new XMLHttp request in a form that don't care about IE6
		
			
			xmlhttp.onreadystatechange = function()
			{
				
				if (this.readyState == 4 && this.status == 200)
				{
					
					var state = this.responseText; //State is the response to this query	
					state = JSON.parse(state);
					
					deskPopUp(state);
				}
			};
			xmlhttp.open("GET","https://zeno.computing.dundee.ac.uk/2018-projects/team1/rolling/wrldDatabaseFetch.php?q="+event.ids[1],true);
			xmlhttp.send();
		
		}

		
    }
	
	//getHighlightedDesks.php
	
	
	
	function highlightDesks()
	{
		var state;
		//Get the JSON object
		xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function()
		{
			
			if (this.readyState == 4 && this.status == 200)
			{
				
				state = this.responseText;
				state = JSON.parse(state);
	
				performHighlighting(state);
			}	
		};
		xmlhttp.open("GET","getHighlightedDesks.php?",true);
		xmlhttp.send();
		
		
	}
	
	function performHighlighting(state)
	{
		//Will highlight all the desks in the array
		state.map(function(desk){
			var id = desk.desk_ID + "";
			if (id.length == 1) {id = '000'+id;}
			if (id.length == 2) {id = '00'+id;}
			if (id.length == 3) {id = '0'+id;}
			
			if(desk.Available == 0)
				map.indoors.setEntityHighlights(id, [255,0,0,255]);
			else
				map.indoors.setEntityHighlights(id, [0,255,0,255]);
		});
		
	}
	
	
	
	
	function onMouseDown(event)
	{
		
		mousePoint = event.latlng;

		
	}
	
	function deskPopUp(state)
	{
		//Now we slit state into 3 sections
		

		
		//Set the time
		
		alert(state.jobDateTimeStart);
		popUpTime = new Date(state.jobDateTimeStart);
		
		
		
		
		
			
		var timeToo = timeUntilNow(popUpTime);
		
		if (state.jobDateTimeStart = 'null')
		{
			//This means they have nothing avalible
			timeToo = 'null';
		}
		
		currentContent = state.firstName+' '+state.lastName;
		var content = getAppropriateContent(currentContent, timeToo, state.isPresent);
		
		
		map.openPopup(content, mousePoint, {indoorMapId: 'westport_house', indoorMapFloorId: 2});
		
	}
	
	function timeUntilNow(targetTime)
	{
		var now = new Date();
		var timeToo = (targetTime.getTime() - now.getTime()) / 1000;
		timeToo /= 60;
		timeToo = Math.ceil(timeToo);
		return timeToo;
	}
	
	function getAppropriateContent(name, time, assigned)
	{
		
		//This function will return the approrpate content for a popup based off time
		
		var timeDisplayMode = 0; //This is the mode to display time in, 0 is minutes, 1 is hours and minutes, 2 is hours
		var content = '<span class="popuptext" id="myPopup"> <h5 align="right"></h5><h3 align="left">'; //The base content for a popup
		if (name == 'null null')
		{
			content = '<span class="popuptext" id="myPopup"> <h5 align="right"></h5><h3 align="left"> DESK UNASIGNED</h3><h4 style="background-color:red;"></h4>  </span>';
			return content;
		}
		content = content+name;
		//Now check if somebody is at the desk
		
		
		if (time == 'null')
		{
			timeDisplayMode = 3;
		}
		else
		{

			if (time >= 60)
				{
					timeDisplayMode = 1
					if (time >= 180)
					{
						timeDisplayMode = 2;
					}
				}
		}
		//Start off by calculating the mode
		var timeContent = '';
		//Generate time display text
		switch(timeDisplayMode)
		{
			case 0:
				timeContent = time+' minutes.';
				break;
				
			case 1:
				//Calculate number of minutes and hours
				var timeCalc = time;
				var hours = 0;
				while (timeCalc > 60)
				{
					hours++;
					timeCalc-60;
				}
				timeContent = hours+' hours, '+timeCalc+' minutes.';
				break;
			case 2:
				//Just calculate the number of hours
				var hours = time/60;
				//Round hours down
				hours = Math.floor(hours);
				timeContent = hours+' hours';
				break;
			case 3:
				//No assigned job
				timeContent = 'N/A';
				break;
		}
		
		switch(assigned)
		{
			case "0":
				content = content+'</h3><h4>Is  not currently at this desk';
				break;
			
			case "1":
				content = content+'</h3><h4>Is available for ' + timeContent;
				break;
		}
		
		content = content+'</h4>  </span>';
		if (name == 'null null')
		{
			content = '<span class="popuptext" id="myPopup"> <h5 align="right"></h5><h3 align="left"> DESK UNASIGNED</h3><h4 style="background-color:red;"></h4>  </span>';
		}
		return content;
		
		
		
	}
	
	
	
	
	
	function moveUp() {
        map.indoors.moveUp();
		}

      function moveDown() {
        map.indoors.moveDown();
      }

      function bottomFloor() {
        map.indoors.setFloor(0);
      }

      function exitIndoors() {
        map.indoors.exit();
      }
	  function displayIDS(id) {
		alert(id);
	  }


	  
	  function popupExists(event) {
	  
		//This is a bodge
		popup = event.popup;
	  }
	  function update() {
	  
		updateCnt++;

		if ((updateCnt == 30))
		{
			
			updateCnt = 0;
			highlightDesks();
			//Highlight all the desks
			//Update the date and time
			
			//Calculate the current time
			

			var timeToo = timeUntilNow(popUpTime);
			
			
			if ((popup != null) && (selctedDeskInUse == true) && (popUpTime.getTime() != 0))
			{
				var content = '<span class="popuptext" id="myPopup"> <h5 align="right"></h5><h3 align="left">'+currentContent+'</h3><h4 style="background-color:green;">Is available for '+timeToo+' minutes</h4>  </span>';
				popup.setContent(content);
				popup.update();
			}
			
		}
	  }
	  
	  
	//You aren't allowed to leave
	
	
	//Event handlers?
	map.indoors.on("indoorentityclick", onIndoorEntityClicked); //When an indoor entity is clicked
	map.on("popupopen", popupExists);
	map.on("mousedown", onMouseDown); //When the mouse is clicked
	map.on("update", update); //On every frame
	

</script>

<div/>


<body/>